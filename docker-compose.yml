
services:
  tests:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - FLASK_ENV=testing  # Set environment for testing
      - DATABASE_URL=sqlite:///app/palindromes.db  # Use the same database in the app folder
      - INSTANCE_PATH=/palindrom_project/instance  # Instance folder for runtime data
    volumes:
      - .:/palindrom_project  # Mount the project directory for test access
      - instance_data:/palindrom_project/instance  # Persist the instance folder
      - allure_results:/allure-results  # Persist Allure test results
    entrypoint: pytest --alluredir=/allure-results  # Run pytest and generate Allure results

  allure:
    image: frankescobar/allure-docker-service
    ports:
      - "5050:5050"  # Expose Allure on port 5050
    volumes:
      - allure_results:/app/allure-results  # Access results generated by tests
      - allure_report:/app/allure-report  # Store the generated report
    environment:
      - CHECK_RESULTS_EVERY_SECONDS=5  # Automatically check for new test results
      - KEEP_HISTORY=1  # Keep history of reports for comparison
      - ALLURE_RESULTS_DIRECTORY=/app/allure-results
      - ALLURE_REPORT_DIRECTORY=/app/allure-report
    user: "0:0"  # Run as root to avoid permission issues

volumes:
  instance_data:  # Volume for the instance folder
  allure_results:  # Volume to store Allure results
  allure_report:  # Volume to store the generated Allure report


